<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Kerjaan Bleau</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007AFF; 
            --primary-hover-color: #0056b3;
            --secondary-color: #6c757d; 
            --light-color: #f8f9fa; 
            --dark-color: #212529; 
            --card-bg-color: #ffffff;
            --border-color: #dee2e6; 
            --shadow-color: rgba(0, 0, 0, 0.075);
            --font-family-sans-serif: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;

            --status-belum: #ffc107; 
            --status-proses: #17a2b8; 
            --status-selesai: #28a745; 
            --status-overdue: #dc3545; 
        }

        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: var(--font-family-sans-serif); margin: 0;
            background-color: var(--light-color); color: var(--dark-color);
            line-height: 1.6; font-size: 15px; 
            -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%;
        }
        .container { width: 100%; padding: 0 10px; margin: 10px auto; }
        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #0056b3 100%);
            color: white; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; 
            display: flex; flex-direction: column; gap: 10px; text-align: center;
            box-shadow: 0 8px 16px var(--shadow-color);
        }
        header h1 { margin: 0; font-size: 1.8em; font-weight: 600; }
        header button#openInputModalBtn { width: 100%; padding: 10px 15px; font-size: 0.95em; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .dashboard-section { background-color: var(--card-bg-color); padding: 15px; border-radius: 12px; box-shadow: 0 6px 20px var(--shadow-color); }
        .dashboard-section-header { display: flex; flex-direction: column; align-items: flex-start; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .dashboard-section-header h2 { margin: 0; color: var(--primary-color); font-size: 1.3em; font-weight: 600; }
        .filter-controls { width: 100%; }
        .filter-controls label { margin-right: 8px; font-weight: 500; color: var(--secondary-color); font-size: 0.9em; display: block; margin-bottom: 5px;}
        .filter-controls select { width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border-color); font-size: 0.9em; background-color: #fff;}
        
        .task-list { list-style-type: none; padding: 0; max-height: 400px; overflow-y: auto; }
        .task-item { background-color: #fff; border: 1px solid var(--border-color); padding: 12px 15px; margin-bottom: 10px; border-radius: 10px; cursor: pointer; transition: all 0.2s ease-out; box-shadow: 0 3px 6px rgba(0,0,0,0.05); position: relative; }
        .task-item:hover { border-left: 5px solid var(--primary-color); padding-left: 10px; box-shadow: 0 5px 12px rgba(0,0,0,0.08); transform: translateX(2px); }
        .task-item strong { display: block; font-size: 1.05em; font-weight: 600; color: var(--dark-color); margin-bottom: 6px; }
        .task-item .task-meta { font-size: 0.85em; color: var(--secondary-color); margin-bottom: 6px; display: flex; flex-direction: column; align-items: flex-start; gap: 4px; }
        .task-item .deadline { font-weight: 500; }
        .task-item .task-status { display: inline-block; padding: 3px 8px; border-radius: 20px; font-size: 0.75em; font-weight: 500; color: white; }
        .status-belum { background-color: var(--status-belum); color: var(--dark-color);}
        .status-proses { background-color: var(--status-proses); }
        .status-selesai { background-color: var(--status-selesai); }
        .task-overdue .deadline { color: var(--status-overdue) !important; font-weight: 700; }
        .task-overdue::before { content: "Lewat Tenggat!"; position: absolute; top: -6px; right: -6px; background-color: var(--status-overdue); color: white; padding: 2px 6px; border-radius: 8px 0 8px 0; font-size: 0.7em; font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 1; }
        .task-item .detail-preview { font-size: 0.9em; color: var(--secondary-color); margin-top: 8px; word-wrap: break-word; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .task-item .task-actions { margin-top:10px; display: flex; flex-direction: column; gap: 8px !important; align-items: stretch; }
        .task-item .task-actions .btn { width: 100%; text-align: center; }

        .no-tasks { color: var(--secondary-color); text-align: center; padding: 25px 15px; font-size: 1em;}
        #pieChartContainer { max-width: 300px; margin: 15px auto; height: 280px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.65); backdrop-filter: blur(5px); align-items: center; justify-content: center; padding: 15px; }
        .modal-content { background-color: var(--card-bg-color); padding: 20px; border: none; width: 95%; max-width: 600px; border-radius: 15px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.15); animation: slideDownModal 0.4s ease-out; margin: auto; max-height: 90vh; overflow-y: auto; }
        #confirmDeleteModal .modal-content { max-width: 400px; }
        #confirmDeleteModal p { font-size: 1.05em; margin-bottom: 18px; text-align: center;}
        #confirmDeleteModal .modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 18px;}
        @keyframes slideDownModal { from { transform: translateY(-25px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .modal-content h2 { color: var(--primary-color); margin-top: 0; margin-bottom: 20px; font-size: 1.4em; font-weight: 600;}
        .close-btn { color: var(--secondary-color); font-size: 30px; font-weight: 300; position: absolute; top: 10px; right: 20px; cursor: pointer; transition: color 0.2s ease; }
        .close-btn:hover, .close-btn:focus { color: var(--dark-color); }
        .form-group, .detail-group { margin-bottom: 18px; }
        label, .detail-label { display: block; margin-bottom: 6px; font-weight: 500; color: var(--secondary-color); font-size: 0.9em; }
        .detail-value { padding: 8px 10px; background-color: var(--light-color); border-radius: 8px; word-wrap: break-word; white-space: pre-wrap; border: 1px solid var(--border-color); font-size: 0.95em; color: var(--dark-color); }
        #attachmentPreviewArea { margin-top: 10px; padding: 12px; border: 1px dashed var(--border-color); min-height: 100px; max-height: 350px; overflow: auto; display: flex; justify-content: center; align-items: center; background-color: var(--light-color); border-radius: 8px; }
        #attachmentPreviewArea img, #attachmentPreviewArea iframe, #attachmentPreviewArea embed { max-width: 100%; max-height: 330px; display: block; margin: auto; border-radius: 4px; }
        #attachmentPreviewArea pre { white-space: pre-wrap; word-wrap: break-word; font-size: 0.9em; max-height: 330px; overflow-y: auto; width: 100%; padding: 8px; background-color: #fff; border: 1px solid var(--border-color); border-radius: 4px; }
        input[type="text"], input[type="date"], textarea, select, input[type="file"] { width: 100%; padding: 10px 12px; box-sizing: border-box; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.95em; font-family: var(--font-family-sans-serif); background-color: #fff; color: var(--dark-color); transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        input[type="text"]:focus, input[type="date"]:focus, textarea:focus, select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 0.15rem rgba(0,123,255,.25); outline: none; }
        input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95em; font-weight: 500; transition: all 0.2s ease; text-decoration: none; display: inline-block; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover-color); transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
        .btn-success { background-color: var(--status-selesai); color: white; }
        .btn-success:hover { background-color: #1e7e34; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
        .btn-danger { background-color: var(--status-overdue); color: white; }
        .btn-danger:hover { background-color: #c82333; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-secondary:hover { background-color: #5a6268; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
        .btn-sm { font-size:0.8em; padding: 6px 12px; }
        form button[type="submit"] { width: 100%; margin-top: 8px;} 
        .summary-stat { font-size: 1em; margin-bottom: 12px; color: var(--secondary-color); }
        .summary-stat strong { font-size: 1.8em; color: var(--primary-color); display: block; margin-bottom: 3px;}
        .text-center { text-align: center; }
        .mt-1 { margin-top: 0.5rem; } .mt-2 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 0.5rem; } .mb-2 { margin-bottom: 1rem; }
        .d-flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .align-items-center { align-items: center; }
        .task-list::-webkit-scrollbar { width: 6px; }
        .task-list::-webkit-scrollbar-track { background: var(--light-color); border-radius: 8px;}
        .task-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 8px;}
        .task-list::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .export-controls { margin-top: 15px; padding:12px; background-color: #e9ecef; border-radius: 8px; display: flex; flex-direction: column; gap: 8px; align-items: stretch;}
        .export-controls > div { display: flex; flex-direction: column; width: 100%; }
        .export-controls label { margin-bottom: 4px; font-size: 0.85em;}
        .export-controls select, .export-controls button { width: 100%; padding: 8px 12px; font-size: 0.9em; }
        
        .calendar-controls { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .calendar-controls h3 { font-size: 1.2em; min-width: auto; order: -1; text-align: center; margin:0 0 8px 0;}
        .calendar-controls .btn-sm { width: 100%; padding: 8px; font-size: 0.9em; }
        .calendar-view table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .calendar-view th, .calendar-view td { padding: 4px; height: 70px; font-size: 0.8em; border: 1px solid var(--border-color); text-align: left; vertical-align: top;}
        .calendar-view th { background-color: #e9ecef; text-align: center; font-weight: 600; padding: 8px 3px; color: var(--secondary-color); }
        .calendar-view .date-number { font-weight: 600; font-size: 0.9em; display: block; margin-bottom: 3px; color: var(--dark-color); }
        .calendar-view .today .date-number { color: var(--primary-color); background-color: #e6f2ff; border-radius: 50%; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; padding: 1px; box-shadow: 0 0 3px var(--primary-color); }
        .calendar-view .other-month .date-number { color: #adb5bd; } 
        .calendar-view .other-month { background-color: #fdfdfd; }
        .calendar-tasks-wrapper { max-height: 35px; overflow-y: auto; } 
        .calendar-task { font-size: 0.75em; padding: 2px 4px; margin-bottom: 2px; border-radius: 3px; background-color: var(--light-color); border-left: 2px solid var(--secondary-color); cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: background-color 0.2s ease; }
        .calendar-task:hover { background-color: #e9ecef; }
        .calendar-task.status-belum { border-left-color: var(--status-belum); }
        .calendar-task.status-proses { border-left-color: var(--status-proses); }
        .calendar-task.status-selesai { border-left-color: var(--status-selesai); text-decoration: line-through; opacity: 0.6; }
        .calendar-task.task-overdue { border-left-color: var(--status-overdue); font-weight: 500; background-color: #ffebee; }
        
        small.validation-message { font-size: 0.8em; margin-top: 4px; display: block; }

        /* Tablet (lebar layar >= 600px) */
        @media (min-width: 600px) {
            body { font-size: 15.5px; } .container { padding: 0 15px; margin: 15px auto; }
            header { flex-direction: row; padding: 20px 25px; text-align: left; gap: 20px; }
            header h1 { font-size: 2em; } header button#openInputModalBtn { width: auto; font-size: 0.95em; }
            .dashboard-grid { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
            .dashboard-section { padding: 20px; } .dashboard-section h2 { font-size: 1.4em; }
            .dashboard-section-header { flex-direction: row; align-items: center; }
            .filter-controls { width: auto; } .filter-controls select { width: auto; }
            .task-item .task-meta { flex-direction: row; align-items: center; gap: 10px;}
            .task-item .task-actions { flex-direction: row; align-items: center; justify-content: flex-start;}
            .task-item .task-actions .btn { width: auto; }
            .modal-content { padding: 25px; width: 85%; }
            #pieChartContainer { max-width: 320px; height: 290px; }
            input[type="text"], input[type="date"], textarea, select, input[type="file"], .btn { font-size: 0.95em; padding: 10px 14px; }
            .calendar-controls { flex-direction: row; gap: 15px;} .calendar-controls .btn-sm { width: auto; }
            .calendar-view th, .calendar-view td { padding: 6px; height: 90px; font-size: 0.9em;}
            .calendar-view .date-number { font-size: 1em; } .calendar-view .today .date-number { width: 26px; height: 26px; }
            .calendar-tasks-wrapper { max-height: 50px; } .calendar-task { font-size: 0.8em; }
            .export-controls { flex-direction: row; align-items: center; gap: 12px; }
            .export-controls > div { flex-direction: row; align-items: center; width: auto; }
            .export-controls label { margin-bottom: 0; margin-right: 6px; }
            .export-controls select, .export-controls button { width: auto; font-size: 0.9em; }
        }

        /* Desktop (lebar layar >= 992px) */
        @media (min-width: 992px) {
            body { font-size: 16px; } .container { width: 90%; max-width: 1280px; margin: 20px auto; padding: 0 20px;}
            header { padding: 25px 30px; } header h1 { font-size: 2.25em; }
            header button#openInputModalBtn { font-size: 1em; }
            .dashboard-grid { gap: 25px; } .dashboard-section { padding: 25px; }
            .dashboard-section h2 { font-size: 1.6em; }
            .task-item .task-actions .btn { font-size: 0.85em; padding: 8px 15px; }
            #pieChartContainer { max-width: 350px; height: 300px; }
            .modal-content { max-width: 650px; padding: 30px; }
            #confirmDeleteModal .modal-content { max-width: 450px; }
            input[type="text"], input[type="date"], textarea, select, input[type="file"], .btn { font-size: 1em; padding: 12px 15px;}
            .calendar-controls h3 { font-size: 1.4em;}
            .calendar-view th, .calendar-view td { padding: 8px; height: 110px; font-size: 1em;}
            .calendar-view .date-number { font-size: 1.1em; } .calendar-view .today .date-number { width: 28px; height: 28px; }
            .calendar-tasks-wrapper { max-height: 70px; }
            .export-controls { gap: 15px; }
            .export-controls select, .export-controls button { font-size: 0.95em; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Dashboard Kerjaan Ali Gans</h1>
            <button id="openInputModalBtn" class="btn btn-success">Tambah Kerjaan +</button>
        </header>

        <div class="dashboard-section export-section">
            <h2>Laporan & Ekspor</h2>
            <div class="export-controls">
                <div>
                    <label for="exportPeriod">Periode:</label>
                    <select id="exportPeriod" class="btn">
                        <option value="all">Semua Kerjaan</option>
                        <option value="this_week">Minggu Ini (Tenggat)</option>
                        <option value="this_month">Bulan Ini (Tenggat)</option>
                    </select>
                </div>
                <div>
                    <label for="exportFormat">Format:</label>
                    <select id="exportFormat" class="btn">
                        <option value="html">Laporan HTML (.html)</option>
                        <option value="json">Data JSON (.json)</option>
                        <option value="csv">Data CSV (.csv)</option>
                    </select>
                </div>
                <button id="exportBtn" class="btn btn-primary">Ekspor Data</button>
            </div>
        </div>

        <div class="dashboard-grid mt-2">
            <div class="dashboard-section">
                <h2>Ringkasan Umum</h2>
                <div id="totalTasks" class="summary-stat">Total Kerjaan <strong>0</strong></div>
                <div id="pieChartContainer">
                    <canvas id="statusPieChart"></canvas>
                </div>
            </div>

            <div class="dashboard-section">
                <h2>Tenggat Terdekat (Belum/Proses)</h2>
                <ul id="nearestDeadlineTasks" class="task-list"></ul>
            </div>
        </div>
        
        <div class="dashboard-section mt-2">
            <div class="calendar-controls">
                <button id="prevMonthBtn" class="btn btn-sm btn-secondary">&lt; Bulan Lalu</button>
                <h3 id="currentMonthYear"></h3>
                <button id="nextMonthBtn" class="btn btn-sm btn-secondary">Bulan Depan &gt;</button>
            </div>
            <div id="calendarView" class="calendar-view mt-2"></div>
        </div>
        
         <div class="dashboard-section mt-2">
            <div class="dashboard-section-header">
                <h2>Semua Kerjaan</h2>
                <div class="filter-controls">
                    <label for="filterBulanSemuaKerjaan">Filter Bulan (Tenggat/Dibuat):</label>
                    <select id="filterBulanSemuaKerjaan">
                        <option value="all">Semua Bulan</option>
                    </select>
                </div>
            </div>
            <ul id="allTasksList" class="task-list"></ul>
        </div>
    </div>

    <div id="inputKerjaanModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeInputModalBtn">&times;</span>
            <h2 id="inputModalTitle">Tambah Kerjaan Baru</h2>
            <form id="formKerjaan">
                <input type="hidden" id="editTaskId">
                <div class="form-group">
                    <label for="namaPekerjaan">Nama Kerjaan:</label>
                    <input type="text" id="namaPekerjaan" required>
                </div>
                <div class="form-group">
                    <label for="detailPekerjaan">Detail Kerjaan:</label>
                    <textarea id="detailPekerjaan" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="durasiTenggat">Helper Durasi (misal: "7 hari", "0 hari"):</label>
                    <input type="text" id="durasiTenggat" placeholder="Akan mengisi tanggal di bawah">
                </div>
                <div class="form-group">
                    <label for="tenggatPicker">Tenggat Waktu:</label>
                    <input type="date" id="tenggatPicker"> 
                    </div>
                <div class="form-group">
                    <label for="statusKerjaan">Status:</label>
                    <select id="statusKerjaan">
                        <option value="belum" selected>Belum Dikerjakan</option>
                        <option value="proses">Proses</option>
                        <option value="selesai">Selesai</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="lampiranFile">Lampiran (Maks 5MB - JPG, PNG, GIF, PDF, TXT):</label>
                    <input type="file" id="lampiranFile" accept="image/jpeg,image/png,image/gif,application/pdf,text/plain">
                    <small id="fileWarning" style="color:var(--status-overdue); display:none; font-size:0.85em; margin-top:5px;"></small>
                </div>
                <button type="submit" class="btn btn-primary">Simpan Kerjaan</button>
            </form>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeDetailModalBtn">&times;</span>
            <h2>Detail Kerjaan</h2>
            <div class="detail-group"><span class="detail-label">Nama:</span><p id="detailNama" class="detail-value"></p></div>
            <div class="detail-group"><span class="detail-label">Deskripsi:</span><p id="detailDeskripsi" class="detail-value"></p></div>
            <div class="detail-group"><span class="detail-label">Status:</span><p id="detailStatus" class="detail-value"></p></div>
            <div class="detail-group"><span class="detail-label">Tenggat:</span><p id="detailTenggat" class="detail-value"></p></div>
            <div class="detail-group">
                <span class="detail-label">Lampiran:</span>
                <p id="detailNamaLampiran" class="detail-value" style="margin-bottom:8px;"></p>
                <div id="attachmentPreviewArea"><p class="text-center">Tidak ada lampiran.</p></div>
            </div>
        </div>
    </div>
    
    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeConfirmDeleteModalBtn">&times;</span>
            <h2>Konfirmasi Hapus</h2>
            <p>Yakin hapus kerjaan "<strong id="taskNameToDelete"></strong>"?</p>
            <div class="modal-actions">
                <button id="cancelDeleteBtn" class="btn btn-secondary">Batal</button>
                <button id="confirmDeleteBtn" class="btn btn-danger">Ya, Hapus</button>
            </div>
        </div>
    </div>

    <script src="data_manager.js"></script> 
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let statusPieChartInstance = null;
            let allTasksCache = []; 

            const inputModal = document.getElementById('inputKerjaanModal');
            const openInputModalBtn = document.getElementById('openInputModalBtn');
            const closeInputModalBtn = document.getElementById('closeInputModalBtn');
            const detailModal = document.getElementById('detailModal');
            const closeDetailModalBtn = document.getElementById('closeDetailModalBtn');
            const inputModalTitle = document.getElementById('inputModalTitle');
            const confirmDeleteModal = document.getElementById('confirmDeleteModal');
            const closeConfirmDeleteModalBtn = document.getElementById('closeConfirmDeleteModalBtn');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const taskNameToDeleteSpan = document.getElementById('taskNameToDelete');
            let taskIdToDelete = null;

            const formKerjaan = document.getElementById('formKerjaan');
            const editTaskIdInput = document.getElementById('editTaskId');
            const namaPekerjaanInput = document.getElementById('namaPekerjaan');
            const detailPekerjaanInput = document.getElementById('detailPekerjaan');
            const durasiTenggatInput = document.getElementById('durasiTenggat');
            // Ganti input tenggat waktu ke type="date"
            const tenggatPicker = document.getElementById('tenggatPicker'); 
            // tenggatWaktuOutput dan tenggatWaktuSortable tidak lagi jadi input utama, nilainya akan diambil dari tenggatPicker

            const statusKerjaanSelect = document.getElementById('statusKerjaan');
            const lampiranFileInput = document.getElementById('lampiranFile');
            const fileWarning = document.getElementById('fileWarning');
            
            const totalTasksDisplay = document.querySelector('#totalTasks strong');
            const nearestDeadlineTasksList = document.getElementById('nearestDeadlineTasks');
            const allTasksList = document.getElementById('allTasksList');
            const filterBulanSemuaKerjaanSelect = document.getElementById('filterBulanSemuaKerjaan');

            const exportPeriodSelect = document.getElementById('exportPeriod');
            const exportFormatSelect = document.getElementById('exportFormat');
            const exportBtn = document.getElementById('exportBtn');

            const calendarView = document.getElementById('calendarView');
            const currentMonthYearDisplay = document.getElementById('currentMonthYear');
            const prevMonthBtn = document.getElementById('prevMonthBtn');
            const nextMonthBtn = document.getElementById('nextMonthBtn');
            let calendarCurrentDate = new Date(); 
            const namaHari = ["Min", "Sen", "Sel", "Rab", "Kam", "Jum", "Sab"];
            const namaBulan = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

            async function initializePage() {
                allTasksCache = await DataManager.getKerjaanList();
                if (filterBulanSemuaKerjaanSelect) { populateMonthFilter(allTasksCache); }
                await renderDashboard(); 
                if (calendarView) { await renderCalendar(calendarCurrentDate.getMonth(), calendarCurrentDate.getFullYear()); }
                // startTitleAnimation(1800); // Jika ada animasi judul
            }

            openInputModalBtn.onclick = () => { 
                formKerjaan.reset(); editTaskIdInput.value = ''; inputModalTitle.textContent = 'Tambah Kerjaan Baru';
                durasiTenggatInput.value = ''; tenggatPicker.value = ''; // Reset date picker
                statusKerjaanSelect.value = 'belum';
                lampiranFileInput.value = ''; fileWarning.style.display = 'none';
                inputModal.style.display = "flex"; namaPekerjaanInput.focus();
            };
            closeInputModalBtn.onclick = () => inputModal.style.display = "none";
            closeDetailModalBtn.onclick = () => detailModal.style.display = "none";
            closeConfirmDeleteModalBtn.onclick = () => confirmDeleteModal.style.display = "none";
            cancelDeleteBtn.onclick = () => confirmDeleteModal.style.display = "none";
            confirmDeleteBtn.onclick = async () => { 
                if (taskIdToDelete !== null) {
                    const result = await DataManager.deleteKerjaanById(taskIdToDelete);
                    if (result && result.status === 'success') { await initializePage(); } 
                    else { alert(result.message || 'Gagal menghapus tugas.'); }
                }
                confirmDeleteModal.style.display = "none"; taskIdToDelete = null;
            };
            window.onclick = (event) => { 
                if (event.target == inputModal) inputModal.style.display = "none";
                if (event.target == detailModal) detailModal.style.display = "none";
                if (event.target == confirmDeleteModal) confirmDeleteModal.style.display = "none";
            };

            // --- Logika Helper Durasi untuk Date Picker ---
            durasiTenggatInput.addEventListener('input', () => {
                const durasiText = durasiTenggatInput.value.trim().toLowerCase();
                if (durasiText === "") {
                    // Biarkan tenggatPicker apa adanya jika durasi dikosongkan
                    // User bisa mengosongkan tenggatPicker secara manual
                    return;
                }
                let jumlahHari;
                if (durasiText.match(/^(-?\d+)\s*hari$/)) jumlahHari = parseInt(durasiText.replace(/\s*hari\s*/, '').trim());
                else if (durasiText.match(/^(-?\d+)$/)) jumlahHari = parseInt(durasiText.trim());
                else {
                    // Format durasi tidak valid, mungkin tampilkan pesan atau abaikan
                    return; 
                }

                if (isNaN(jumlahHari)) return; // Jumlah hari tidak valid

                const hariIni = new Date();
                const tanggalTenggat = new Date(hariIni);
                tanggalTenggat.setDate(hariIni.getDate() + jumlahHari);
                
                // Format untuk input type="date" adalah YYYY-MM-DD
                const yyyy = tanggalTenggat.getFullYear();
                const mm = String(tanggalTenggat.getMonth() + 1).padStart(2, '0');
                const dd = String(tanggalTenggat.getDate()).padStart(2, '0');
                tenggatPicker.value = `${yyyy}-${mm}-${dd}`;
            });

            // Saat date picker diubah, kosongkan helper durasi
            if (tenggatPicker) {
                tenggatPicker.addEventListener('change', () => {
                    durasiTenggatInput.value = '';
                });
            }

            lampiranFileInput.addEventListener('change', function(event) { 
                const file = event.target.files[0]; fileWarning.style.display = 'none';
                if (file) {
                    if (file.size > 5 * 1024 * 1024) { fileWarning.textContent = 'Maks 5MB.'; fileWarning.style.display = 'block'; this.value = ''; return; }
                    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf', 'text/plain'];
                    if (!allowedTypes.includes(file.type)) { fileWarning.textContent = 'Tipe: JPG, PNG, GIF, PDF, TXT.'; fileWarning.style.display = 'block'; this.value = ''; return;}
                    fileWarning.textContent = `File: ${file.name}`; fileWarning.style.color = 'var(--secondary-color)'; fileWarning.style.display = 'block';
                }
            });
            
            formKerjaan.addEventListener('submit', async function(event) {
                event.preventDefault();
                const taskId = editTaskIdInput.value ? parseInt(editTaskIdInput.value) : null;
                
                let tenggatSortableValue = "";
                let tenggatDisplayValue = "";
                if (tenggatPicker.value) { // Jika date picker diisi
                    tenggatSortableValue = tenggatPicker.value; // Formatnya sudah YYYY-MM-DD
                    const parts = tenggatSortableValue.split('-');
                    if(parts.length === 3) {
                        tenggatDisplayValue = `${parts[2]}-${parts[1]}-${parts[0]}`; // DD-MM-YYYY
                    }
                }

                const taskObjectToSave = {
                    id: taskId, 
                    nama: namaPekerjaanInput.value.trim(), 
                    detail: detailPekerjaanInput.value.trim(),
                    tenggatDisplay: tenggatDisplayValue, 
                    tenggatSortable: tenggatSortableValue,
                    status: statusKerjaanSelect.value,
                };

                if (!taskObjectToSave.nama || !taskObjectToSave.detail) { alert('Nama & Detail wajib!'); return; }
                
                const lampiranFileObject = lampiranFileInput.files[0] || null;
                if (taskId) {
                    const existingTask = allTasksCache.find(k => k.id === taskId);
                    if (existingTask) {
                        taskObjectToSave.createdAt = existingTask.createdAt;
                        if (!lampiranFileObject) {
                            taskObjectToSave.lampiranPath = existingTask.lampiranPath;
                            taskObjectToSave.lampiranNamaOriginal = existingTask.lampiranNamaOriginal;
                        }
                    }
                } else { taskObjectToSave.createdAt = new Date().toISOString(); }

                const result = await DataManager.saveOrUpdateKerjaan(taskObjectToSave, lampiranFileObject);
                if (result && result.status === 'success') {
                    inputModal.style.display = "none";
                    await initializePage(); 
                } else { alert(result.message || 'Error menyimpan.'); }
            });

            function populateMonthFilter(tasks) {
                if (!filterBulanSemuaKerjaanSelect) return;
                const currentFilterValue = filterBulanSemuaKerjaanSelect.value;
                filterBulanSemuaKerjaanSelect.innerHTML = '<option value="all">Semua Bulan</option>';
                const months = new Set();
                tasks.forEach(task => {
                    const dateSource = task.tenggatSortable || task.createdAt;
                    if (dateSource) months.add(dateSource.substring(0, 7)); 
                });
                const sortedMonths = Array.from(months).sort((a,b) => b.localeCompare(a));
                sortedMonths.forEach(monthYear => {
                    const option = document.createElement('option'); option.value = monthYear;
                    const [year, month] = monthYear.split('-');
                    option.textContent = `${namaBulan[parseInt(month) - 1]} ${year}`;
                    filterBulanSemuaKerjaanSelect.appendChild(option);
                });
                if (Array.from(filterBulanSemuaKerjaanSelect.options).some(opt => opt.value === currentFilterValue)) {
                    filterBulanSemuaKerjaanSelect.value = currentFilterValue;
                }
            }
            
            if (filterBulanSemuaKerjaanSelect) {
                filterBulanSemuaKerjaanSelect.addEventListener('change', async () => {
                    await renderDashboard(); 
                });
            }

            async function renderDashboard() { 
                const kerjaanList = allTasksCache;
                const selectedMonthYear = filterBulanSemuaKerjaanSelect ? filterBulanSemuaKerjaanSelect.value : 'all';
                totalTasksDisplay.textContent = kerjaanList.length;
                nearestDeadlineTasksList.innerHTML = ''; allTasksList.innerHTML = '';

                if (!kerjaanList || kerjaanList.length === 0) {
                    const noTaskMsg = '<li class="no-tasks">Belum ada kerjaan.</li>';
                    nearestDeadlineTasksList.innerHTML = noTaskMsg; allTasksList.innerHTML = noTaskMsg;
                    renderPieChart([]); return;
                }
                const today = new Date(); today.setHours(0,0,0,0); const todayStr = today.toISOString().split('T')[0];
                const deadlineTasks = kerjaanList.filter(k => (k.status === 'belum' || k.status === 'proses') && k.tenggatSortable).sort((a, b) => new Date(a.tenggatSortable) - new Date(b.tenggatSortable));
                let upcomingDeadlineRendered = 0;
                deadlineTasks.forEach(kerjaan => { if (kerjaan.tenggatSortable >= todayStr && upcomingDeadlineRendered < 5) { nearestDeadlineTasksList.appendChild(createTaskListItem(kerjaan)); upcomingDeadlineRendered++; }});
                if (nearestDeadlineTasksList.children.length === 0) nearestDeadlineTasksList.innerHTML = deadlineTasks.length > 0 ? '<li class="no-tasks">Tidak ada tenggat mendatang.</li>' : '<li class="no-tasks">Tidak ada kerjaan (Belum/Proses) dengan tenggat.</li>';
                
                let filteredForAllTasksList = kerjaanList;
                if (selectedMonthYear !== 'all') {
                    filteredForAllTasksList = kerjaanList.filter(task => { const dateToCheck = task.tenggatSortable || task.createdAt; return dateToCheck && dateToCheck.startsWith(selectedMonthYear); });
                }
                const allTasksSorted = [...filteredForAllTasksList].sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                allTasksList.innerHTML = '';
                if (allTasksSorted.length === 0) allTasksList.innerHTML = `<li class="no-tasks">Tidak ada kerjaan ${selectedMonthYear !== 'all' ? `untuk ${filterBulanSemuaKerjaanSelect.options[filterBulanSemuaKerjaanSelect.selectedIndex].text}` : ''}.</li>`;
                else allTasksSorted.forEach(kerjaan => { allTasksList.appendChild(createTaskListItem(kerjaan, true)); });
                renderPieChart(kerjaanList);
            }

            function getStatusText(statusKey) { const map = {'belum': 'Belum Dikerjakan', 'proses': 'Proses', 'selesai': 'Selesai'}; return map[statusKey] || 'N/A'; }
            function escapeHtml(unsafe) { if (unsafe === null || unsafe === undefined) return ''; return unsafe.toString().replace(/[&<"']/g, m => ({'&': '&amp;', '<': '&lt;', '"': '&quot;', "'": '&#039;'})[m]); }

            function createTaskListItem(kerjaan, includeActions = false) { 
                const listItem = document.createElement('li'); listItem.classList.add('task-item');
                const isOverdue = kerjaan.tenggatSortable && kerjaan.tenggatSortable < new Date().toISOString().split('T')[0] && kerjaan.status !== 'selesai';
                if (isOverdue) listItem.classList.add('task-overdue');
                listItem.setAttribute('data-id', kerjaan.id);
                listItem.addEventListener('click', (e) => { if (!e.target.closest('.btn-action')) showDetailModal(kerjaan.id); });
                let statusBadge = `<span class="task-status status-${kerjaan.status}">${getStatusText(kerjaan.status)}</span>`;
                let deadlineText = kerjaan.tenggatDisplay ? `Tenggat: ${escapeHtml(kerjaan.tenggatDisplay)}` : 'Tanpa Tenggat';
                let actionsHTML = includeActions ? `<div class="task-actions mt-1 d-flex" style="gap:8px;"><button class="btn btn-primary btn-sm btn-action" data-action="edit" data-task-id="${kerjaan.id}">Edit</button><button class="btn btn-danger btn-sm btn-action" data-action="delete" data-task-id="${kerjaan.id}" data-task-name="${escapeHtml(kerjaan.nama)}">Hapus</button></div>` : '';
                listItem.innerHTML = `<strong>${escapeHtml(kerjaan.nama)}</strong><div class="task-meta"><span class="deadline">${deadlineText}</span>${statusBadge}</div><p class="detail-preview">${escapeHtml(kerjaan.detail)}</p>${actionsHTML}`;
                listItem.querySelectorAll('.btn-action').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation(); const action = e.target.dataset.action; const currentTaskId = parseInt(e.target.dataset.taskId);
                        if (action === 'delete') { taskIdToDelete = currentTaskId; taskNameToDeleteSpan.innerHTML = e.target.dataset.taskName; confirmDeleteModal.style.display = "flex"; }
                        else if (action === 'edit') loadTaskForEdit(currentTaskId);
                    });
                });
                return listItem;
            }
            
            async function loadTaskForEdit(taskId) { 
                const task = allTasksCache.find(k => k.id === taskId);
                if (!task) { alert("Tugas tidak ditemukan."); return; }
                editTaskIdInput.value = task.id; inputModalTitle.textContent = 'Edit Kerjaan';
                namaPekerjaanInput.value = task.nama; detailPekerjaanInput.value = task.detail;
                
                durasiTenggatInput.value = ''; // Reset helper durasi
                tenggatPicker.value = task.tenggatSortable || ''; // tenggatSortable sudah YYYY-MM-DD
                // Jika ada tenggat, coba hitung ulang durasi untuk ditampilkan di helper (opsional)
                if (task.tenggatSortable) {
                    const today = new Date(); today.setHours(0,0,0,0);
                    const deadlineDate = new Date(task.tenggatSortable + "T00:00:00Z"); // Pastikan UTC jika tanggal dari server
                    const diffTime = deadlineDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    durasiTenggatInput.value = `${diffDays} hari`;
                }

                statusKerjaanSelect.value = task.status;
                lampiranFileInput.value = ''; fileWarning.style.display = 'none';
                if (task.lampiranNamaOriginal) { fileWarning.textContent = `Lampiran: ${escapeHtml(task.lampiranNamaOriginal)}. Pilih baru utk ganti.`; fileWarning.style.color = 'var(--secondary-color)'; fileWarning.style.display = 'block';}
                inputModal.style.display = 'flex';
            }

            async function showDetailModal(taskId) { 
                const kerjaan = allTasksCache.find(k => k.id === taskId);
                if (!kerjaan) return;
                document.getElementById('detailNama').textContent = kerjaan.nama;
                document.getElementById('detailDeskripsi').textContent = kerjaan.detail;
                document.getElementById('detailTenggat').textContent = kerjaan.tenggatDisplay || 'Tidak ditentukan';
                const detailStatusEl = document.getElementById('detailStatus');
                detailStatusEl.textContent = getStatusText(kerjaan.status); detailStatusEl.className = `detail-value status-${kerjaan.status}`; 
                document.getElementById('detailNamaLampiran').textContent = kerjaan.lampiranNamaOriginal || 'Tidak ada';
                const previewArea = document.getElementById('attachmentPreviewArea'); previewArea.innerHTML = ''; 
                if (kerjaan.lampiranPath && kerjaan.lampiranNamaOriginal) {
                    const fileUrl = kerjaan.lampiranPath; const fileTypeHint = kerjaan.lampiranPath.split('.').pop().toLowerCase();
                    if (['jpg', 'jpeg', 'png', 'gif'].includes(fileTypeHint)) { const img = document.createElement('img'); img.src = fileUrl; img.alt = kerjaan.lampiranNamaOriginal; previewArea.appendChild(img); }
                    else if (fileTypeHint === 'pdf') { previewArea.innerHTML = `<p><a href="${fileUrl}" target="_blank" class="btn btn-primary btn-sm">Lihat PDF: ${escapeHtml(kerjaan.lampiranNamaOriginal)}</a></p>`; }
                    else if (fileTypeHint === 'txt') {
                        try { const response = await fetch(fileUrl); if (response.ok) { const textContent = await response.text(); const pre = document.createElement('pre'); pre.textContent = textContent; previewArea.appendChild(pre); } else { previewArea.innerHTML = `<p class="text-center"><a href="${fileUrl}" target="_blank">Lihat ${escapeHtml(kerjaan.lampiranNamaOriginal)}</a> (Gagal preview)</p>`; }}
                        catch (e) { previewArea.innerHTML = `<p class="text-center"><a href="${fileUrl}" target="_blank">Lihat ${escapeHtml(kerjaan.lampiranNamaOriginal)}</a> (Error preview)</p>`;}
                    } else { previewArea.innerHTML = `<p class="text-center"><a href="${fileUrl}" target="_blank">Unduh: ${escapeHtml(kerjaan.lampiranNamaOriginal)}</a> (Preview tidak didukung)</p>`;}
                } else previewArea.innerHTML = '<p class="text-center">Tidak ada lampiran.</p>';
                detailModal.style.display = 'flex';
            }

            function renderPieChart(kerjaanList) { 
                const ctx = document.getElementById('statusPieChart').getContext('2d');
                const counts = kerjaanList.reduce((acc, k) => { acc[k.status] = (acc[k.status] || 0) + 1; return acc; }, {});
                const data = { labels: ['Belum Dikerjakan', 'Proses', 'Selesai'],
                    datasets: [{ data: [counts.belum || 0, counts.proses || 0, counts.selesai || 0],
                        backgroundColor: [getComputedStyle(document.documentElement).getPropertyValue('--status-belum').trim(), getComputedStyle(document.documentElement).getPropertyValue('--status-proses').trim(), getComputedStyle(document.documentElement).getPropertyValue('--status-selesai').trim()],
                        borderColor: getComputedStyle(document.documentElement).getPropertyValue('--card-bg-color').trim(),
                        borderWidth: 3, hoverOffset: 10, hoverBorderColor: getComputedStyle(document.documentElement).getPropertyValue('--dark-color').trim(), hoverBorderWidth: 1
                    }]};
                if (statusPieChartInstance) { statusPieChartInstance.data = data; statusPieChartInstance.update(); }
                else { statusPieChartInstance = new Chart(ctx, { type: 'doughnut', data: data, options: { responsive: true, maintainAspectRatio: false, animation: { animateScale: true, animateRotate: true }, plugins: { legend: { position: 'bottom', labels: { font: { family: getComputedStyle(document.documentElement).getPropertyValue('--font-family-sans-serif').trim(), size: 13 }, padding: 20, usePointStyle: true, pointStyle: 'rectRounded', boxWidth: 18, boxHeight: 12 }}, title: { display: false }, tooltip: { bodyFont: { family: getComputedStyle(document.documentElement).getPropertyValue('--font-family-sans-serif').trim() }, backgroundColor: 'rgba(0,0,0,0.8)', titleFont: { weight: 'bold', size: 14 }, bodySpacing: 4, padding: 12, cornerRadius: 6, displayColors: true, callbacks: { label: (ctx) => `${ctx.label || ''}: ${ctx.parsed || 0}` }}}, cutout: '70%'}}); }
            }

            function getWeekRange(date) { 
                const d = new Date(date); d.setHours(0,0,0,0); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                const start = new Date(d.setDate(diff)); const end = new Date(start); end.setDate(start.getDate() + 6); end.setHours(23,59,59,999);
                return {start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0]};
            }
            function getMonthRange(date) {
                const d = new Date(date); const start = new Date(d.getFullYear(), d.getMonth(), 1); const end = new Date(d.getFullYear(), d.getMonth() + 1, 0); end.setHours(23,59,59,999);
                return {start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0]};
            }
            
            function filterTasksByPeriodForExport(tasksToFilter, period) { 
                const today = new Date(); if (period === "all") return tasksToFilter; let range;
                if (period === "this_week") range = getWeekRange(today); else if (period === "this_month") range = getMonthRange(today); else return [];
                return tasksToFilter.filter(task => { const taskDate = task.tenggatSortable || task.createdAt.split('T')[0]; return taskDate && taskDate >= range.start && taskDate <= range.end; });
            }
            function convertToCSV(tasks) { 
                if (!tasks || tasks.length === 0) return ""; const headers = ["ID", "Nama Kerjaan", "Detail", "Status", "Tenggat Waktu", "Lampiran", "Dibuat Pada"];
                const csvRows = [headers.join(",")];
                tasks.forEach(task => { const row = [ task.id, `"${(task.nama || "").replace(/"/g, '""')}"`, `"${(task.detail || "").replace(/"/g, '""')}"`, getStatusText(task.status), task.tenggatDisplay || "", task.lampiranNamaOriginal || "", new Date(task.createdAt).toLocaleString('id-ID') ]; csvRows.push(row.join(",")); });
                return csvRows.join("\n");
            }
            function convertToHTMLReport(tasks, periodTitle) { 
                 let taskRows = tasks && tasks.length > 0 ? tasks.map(task => `<tr><td>${task.id}</td><td>${escapeHtml(task.nama)}</td><td style="max-width:300px;word-wrap:break-word;">${escapeHtml(task.detail)}</td><td>${getStatusText(task.status)}</td><td>${escapeHtml(task.tenggatDisplay) || '-'}</td><td>${escapeHtml(task.lampiranNamaOriginal) || '-'}</td><td>${new Date(task.createdAt).toLocaleDateString('id-ID')}</td></tr>`).join('') : '<tr><td colspan="7" style="text-align:center;">Tidak ada data.</td></tr>';
                 return `<!DOCTYPE html><html lang="id"><head><meta charset="UTF-8"><title>Laporan Kerjaan - ${periodTitle}</title><style>body{font-family:Arial,sans-serif;margin:20px}h1{text-align:center;color:#333}table{width:100%;border-collapse:collapse;margin-top:20px;font-size:.9em}th,td{border:1px solid #ddd;padding:10px;text-align:left}th{background-color:#f2f2f2;color:#333}tr:nth-child(even){background-color:#f9f9f9}</style></head><body><h1>Laporan Kerjaan - ${periodTitle}</h1><table><thead><tr><th>ID</th><th>Nama Kerjaan</th><th>Detail</th><th>Status</th><th>Tenggat</th><th>Lampiran</th><th>Dibuat</th></tr></thead><tbody>${taskRows}</tbody></table><p style="text-align:center;margin-top:20px;font-size:.8em">Laporan dibuat pada: ${new Date().toLocaleString('id-ID')}</p></body></html>`;
            }
            function triggerDownload(filename, content, mimeType) { 
                const blob = new Blob([content], { type: mimeType }); const link = document.createElement("a");
                link.href = URL.createObjectURL(blob); link.download = filename;
                document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href);
            }

            exportBtn.addEventListener('click', async () => { 
                const period = exportPeriodSelect.value; const format = exportFormatSelect.value;
                const tasksToExport = filterTasksByPeriodForExport(allTasksCache, period); 
                if (tasksToExport.length === 0) { alert("Tidak ada data untuk diekspor."); return; }
                let content, filename, mimeType;
                const periodTextMap = { "all": "Semua", "this_week": "Minggu Ini", "this_month": "Bulan Ini" };
                const periodTitle = periodTextMap[period] || "Data"; const dateSuffix = new Date().toISOString().split('T')[0];
                if (format === "json") { content = JSON.stringify(tasksToExport, null, 2); filename = `kerjaan_${period.replace('_','-')}_${dateSuffix}.json`; mimeType = "application/json"; }
                else if (format === "csv") { content = convertToCSV(tasksToExport); filename = `kerjaan_${period.replace('_','-')}_${dateSuffix}.csv`; mimeType = "text/csv;charset=utf-8;"; }
                else if (format === "html") { content = convertToHTMLReport(tasksToExport, periodTitle); filename = `laporan_kerjaan_${period.replace('_','-')}_${dateSuffix}.html`; mimeType = "text/html;charset=utf-8;"; }
                if (content) triggerDownload(filename, content, mimeType);
            });

            async function renderCalendar(month, year) { 
                if (!calendarView || !currentMonthYearDisplay) return;
                const tasksToDisplayInCalendar = allTasksCache; 
                calendarView.innerHTML = ''; 
                currentMonthYearDisplay.textContent = `${namaBulan[month]} ${year}`;
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const table = document.createElement('table'); const thead = document.createElement('thead'); const tbody = document.createElement('tbody');
                const headerRow = document.createElement('tr');
                namaHari.forEach(dayName => { const th = document.createElement('th'); th.textContent = dayName; headerRow.appendChild(th); });
                thead.appendChild(headerRow); table.appendChild(thead);
                let date = 1;
                for (let i = 0; i < 6; i++) {
                    const weekRow = document.createElement('tr');
                    for (let j = 0; j < 7; j++) {
                        const cell = document.createElement('td');
                        if (i === 0 && j < firstDayOfMonth) { cell.classList.add('other-month'); }
                        else if (date > daysInMonth) { cell.classList.add('other-month'); }
                        else {
                            const dateNumberSpan = document.createElement('span'); dateNumberSpan.classList.add('date-number'); dateNumberSpan.textContent = date; cell.appendChild(dateNumberSpan);
                            const today = new Date();
                            if (date === today.getDate() && year === today.getFullYear() && month === today.getMonth()) cell.classList.add('today');
                            const currentDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                            const tasksOnThisDate = tasksToDisplayInCalendar.filter(task => task.tenggatSortable === currentDateStr);
                            if (tasksOnThisDate.length > 0) {
                                const taskListDiv = document.createElement('div'); taskListDiv.classList.add('calendar-tasks-wrapper');
                                tasksOnThisDate.forEach(task => {
                                    const taskDiv = document.createElement('div'); taskDiv.classList.add('calendar-task', `status-${task.status}`);
                                    taskDiv.textContent = task.nama; taskDiv.title = `${task.nama} (Status: ${getStatusText(task.status)})`;
                                    taskDiv.setAttribute('data-task-id', task.id);
                                    const isTaskOverdue = task.tenggatSortable && task.tenggatSortable < new Date().toISOString().split('T')[0] && task.status !== 'selesai';
                                    if (isTaskOverdue) taskDiv.classList.add('task-overdue');
                                    taskDiv.addEventListener('click', () => { showDetailModal(parseInt(task.id)); });
                                    taskListDiv.appendChild(taskDiv);
                                });
                                cell.appendChild(taskListDiv);
                            }
                            date++;
                        }
                        weekRow.appendChild(cell);
                    }
                    tbody.appendChild(weekRow);
                    if (date > daysInMonth && i >= Math.ceil((firstDayOfMonth + daysInMonth) / 7) -1) break;
                }
                table.appendChild(tbody); calendarView.appendChild(table);
            }

            if (prevMonthBtn && nextMonthBtn && calendarView) {
                prevMonthBtn.addEventListener('click', async () => { calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() - 1); await renderCalendar(calendarCurrentDate.getMonth(), calendarCurrentDate.getFullYear()); });
                nextMonthBtn.addEventListener('click', async () => { calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + 1); await renderCalendar(calendarCurrentDate.getMonth(), calendarCurrentDate.getFullYear()); });
            }
            
            initializePage();
        });
    </script>

</body>
</html>